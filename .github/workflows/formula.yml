name: Update Homebrew Formula

on:
  push:
    branches:
      - main
  release:
    types: [published]

permissions:
  contents: write

jobs:
  update-formula:
    name: Update Homebrew Formula
    runs-on: ubuntu-latest

    steps:
      - name: Checkout current repository
        uses: actions/checkout@v4

      - name: Checkout Homebrew Tap
        uses: actions/checkout@v4
        with:
          repository: s00d/homebrew-rocksdbfusion
          path: homebrew-tap
          token: ${{ secrets.GH_TOKEN }}

      - name: Create Formula Directory if it does not exist
        run: mkdir -p homebrew-tap/Formula

      - name: Copy formula to Homebrew Tap
        run: cp homebrew/Formula/rocksdb_fusion.rb homebrew-tap/Formula/

      - name: List files in Homebrew Tap directory
        run: ls -l homebrew-tap/Formula/

      - name: Calculate SHA256 checksums and set version
        id: sha256
        run: |
          VERSION=$(grep '^version =' server/Cargo.toml | sed 's/version = "\(.*\)"/\1/')
          MACOS_X86_64_URL="https://github.com/s00d/RocksDBFusion/releases/download/server-v${VERSION}/rocksdb_server-Darwin-x86_64.tar.gz"
          MACOS_AARCH64_URL="https://github.com/s00d/RocksDBFusion/releases/download/server-v${VERSION}/rocksdb_server-Darwin-aarch64.tar.gz"
          LINUX_X86_64_URL="https://github.com/s00d/RocksDBFusion/releases/download/server-v${VERSION}/rocksdb_server-Linux-x86_64-musl.tar.gz"
          LINUX_AARCH64_URL="https://github.com/s00d/RocksDBFusion/releases/download/server-v${VERSION}/rocksdb_server-Linux-aarch64-musl.tar.gz"
          
          # Скачивание и вычисление хеша для macOS x86_64
          curl -L -o rocksdb_server-Darwin-x86_64.tar.gz $MACOS_X86_64_URL
          MACOS_X86_64_SHA256=$(sha256sum rocksdb_server-Darwin-x86_64.tar.gz | awk '{print $1}')
          echo "MACOS_X86_64_SHA256=$MACOS_X86_64_SHA256" >> $GITHUB_ENV
          
          # Скачивание и вычисление хеша для macOS aarch64
          curl -L -o rocksdb_server-Darwin-aarch64.tar.gz $MACOS_AARCH64_URL
          MACOS_AARCH64_SHA256=$(sha256sum rocksdb_server-Darwin-aarch64.tar.gz | awk '{print $1}')
          echo "MACOS_AARCH64_SHA256=$MACOS_AARCH64_SHA256" >> $GITHUB_ENV
          
          # Скачивание и вычисление хеша для Linux x86_64
          curl -L -o rocksdb_server-Linux-x86_64-musl.tar.gz $LINUX_X86_64_URL
          LINUX_X86_64_SHA256=$(sha256sum rocksdb_server-Linux-x86_64-musl.tar.gz | awk '{print $1}')
          echo "LINUX_X86_64_SHA256=$LINUX_X86_64_SHA256" >> $GITHUB_ENV
          
          # Скачивание и вычисление хеша для Linux aarch64
          curl -L -o rocksdb_server-Linux-aarch64-musl.tar.gz $LINUX_AARCH64_URL
          LINUX_AARCH64_SHA256=$(sha256sum rocksdb_server-Linux-aarch64-musl.tar.gz | awk '{print $1}')
          echo "LINUX_AARCH64_SHA256=$LINUX_AARCH64_SHA256" >> $GITHUB_ENV
          
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          
          # Отладочный вывод
          echo "MACOS_X86_64_SHA256=$MACOS_X86_64_SHA256"
          echo "MACOS_AARCH64_SHA256=$MACOS_AARCH64_SHA256"
          echo "LINUX_X86_64_SHA256=$LINUX_X86_64_SHA256"
          echo "LINUX_AARCH64_SHA256=$LINUX_AARCH64_SHA256"
          echo "VERSION=$VERSION"

      - name: Update Homebrew Formula
        run: |
          FORMULA_FILE="homebrew-tap/Formula/rocksdb_fusion.rb"
          VERSION=${{ env.VERSION }}
          MACOS_X86_64_SHA256=${{ env.MACOS_X86_64_SHA256 }}
          MACOS_AARCH64_SHA256=${{ env.MACOS_AARCH64_SHA256 }}
          LINUX_X86_64_SHA256=${{ env.LINUX_X86_64_SHA256 }}
          LINUX_AARCH64_SHA256=${{ env.LINUX_AARCH64_SHA256 }}

          echo "Updating formula at $FORMULA_FILE with version $VERSION"
          
          sed -i "s|version \".*\"|version \"${VERSION}\"|" "$FORMULA_FILE"
          sed -i "s|url \".*Darwin-x86_64.tar.gz\"|url \"https://github.com/s00d/RocksDBFusion/releases/download/server-v${VERSION}/rocksdb_server-Darwin-x86_64.tar.gz\"|" "$FORMULA_FILE"
          sed -i "s|sha256 \".*\"|sha256 \"${MACOS_X86_64_SHA256}\"|" "$FORMULA_FILE"
          sed -i "s|url \".*Darwin-aarch64.tar.gz\"|url \"https://github.com/s00d/RocksDBFusion/releases/download/server-v${VERSION}/rocksdb_server-Darwin-aarch64.tar.gz\"|" "$FORMULA_FILE"
          sed -i "s|sha256 \".*\"|sha256 \"${MACOS_AARCH64_SHA256}\"|" "$FORMULA_FILE"
          sed -i "s|url \".*Linux-x86_64-musl.tar.gz\"|url \"https://github.com/s00d/RocksDBFusion/releases/download/server-v${VERSION}/rocksdb_server-Linux-x86_64-musl.tar.gz\"|" "$FORMULA_FILE"
          sed -i "s|sha256 \".*\"|sha256 \"${LINUX_X86_64_SHA256}\"|" "$FORMULA_FILE"
          sed -i "s|url \".*Linux-aarch64-musl.tar.gz\"|url \"https://github.com/s00d/RocksDBFusion/releases/download/server-v${VERSION}/rocksdb_server-Linux-aarch64-musl.tar.gz\"|" "$FORMULA_FILE"
          sed -i "s|sha256 \".*\"|sha256 \"${LINUX_AARCH64_SHA256}\"|" "$FORMULA_FILE"
          
          git -C homebrew-tap config user.name "github-actions"
          git -C homebrew-tap config user.email "github-actions@github.com"
          git -C homebrew-tap add Formula/rocksdb_fusion.rb
          git -C homebrew-tap commit -m "Update Homebrew formula for version $VERSION"
          git -C homebrew-tap push https://x-access-token:${{ secrets.GH_TOKEN }}@github.com/s00d/homebrew-rocksdbfusion.git main
